<html xmlns:fb="http://www.facebook.com/2008/fbml" xmlns:og="http://opengraphprotocol.org/schema/" xmlns="http://www.w3.org/1999/xhtml"><head>
  <meta content="text/html;charset=UTF-8" http-equiv="Content-Type">
  <title>Photo Share - Cloudinary and PubNub demo</title>
  <link href="http://cloudinary.com/favicon.png" rel="shortcut icon" type="image/png">
  <script src="/js/jquery.min.js" type="text/javascript"></script>
  <script src="/js/jquery.timeago.js" type="text/javascript"></script>
  <script src="/js/jquery.ui.widget.js" type="text/javascript"></script>
  <script src="/js/jquery.iframe-transport.js" type="text/javascript"></script>
  <script src="/js/jquery.fileupload.js" type="text/javascript"></script>
  <script src="/js/jquery.cloudinary.js" type="text/javascript"></script>
  <script src="http://pubnub.s3.amazonaws.com/pubnub-3.1.min.js" type="text/javascript"></script>
  <link href="/stylesheets/photo_share.css" media="screen" rel="stylesheet" type="text/css">
  <meta content="initial-scale=0.48, maximum-scale=4" name="viewport">
  <script type="text/javascript">$.cloudinary.config({"api_key":"118815251311357","cloud_name":"cloudinary-pubnub-demo","private_cdn":false});</script>  <script>
    $(function() {
   
      var transformations = {"natural":{"width":150,"height":100,"crop":"fill","gravity":"face","radius":20},"sepia":{"width":150,"height":100,"crop":"fill","gravity":"face","radius":20,"effect":"sepia"},"improved":{"width":150,"height":100,"crop":"fill","gravity":"face","radius":20,"effect":"improve"},"blue":{"transformation":[{"width":150,"height":100,"crop":"fill","gravity":"face","radius":20,"effect":"hue:70"},{"effect":"blue:50"}]}};
      var large_transformation = {"width":600,"height":600,"crop":"limit"};
   
      // Intializing PubNub Javascript client.
      var channel = 'cloudinary_photo_share';
      var pubnub = PUBNUB.init({ subscribe_key : 'sub-c-e47a6666-dcd1-11e2-859d-02ee2ddab7fe' });
   
      // A function for displaying a live message received from the PubNub channel
      function show_message(message) {
        // Build Cloudinary URL of the large image.
        var large_image_url = $.cloudinary.url(message.cloudinary_photo_id, large_transformation);
       
        var li = $('<li></li>').addClass('photo_item').hide();
       
        // Add a clickable thumbnail generated by Cloudinary and delivered through a CDN.
        var link = $('<a></a>').addClass('image_link').attr('target', '_blank').
          attr('href', large_image_url).append($.cloudinary.image(message.cloudinary_photo_id, transformations[message.kind]));          
        $(li).append(link);
        $(li).append($('<span></span>').addClass('user').text(message.user));
        $(li).append($('<span></span>').addClass('message').text(message.message));
        $(li).append($('<a></a>').addClass('view_link').attr('target', '_blank').attr('href', large_image_url).text('View image'));
        $(li).append($('<abbr></abbr>').addClass('timeago').attr('title', message.time).timeago());
       
        // Add the message item to the live stream view.
        $('.stream').prepend(li);
        $(li).show('slow');
      }
     
      // Subscribe to PubNub channel. Show received messages.
      pubnub.subscribe({
        channel : channel,
        callback : show_message
      });
     
      // Fetch 5 messages from the PubNub history of the channel and show them in the live stream.
      pubnub.history({
        channel  : channel,
        limit    : 5,
        callback : function(history) { $.each(history, function() { show_message(this); })}
      });
   
      // Send image identifier, user's name & message to the server that will publish it to the channel.
      $('.share_form').submit(function() {          
        $.ajax({
          type: "POST",
          url: $(this).attr('action'),
          dataType: 'json',
          data: $(this).serialize()
        });
        $('.upload_section').removeClass('uploaded');
        return false;
      });
             
      // Display the upload progress bar when uploading starts.          
      $('.cloudinary-fileupload').bind('fileuploadstart', function(e, data) {
        $('.progress_bar .completed').css('width', '0%');
        $('.upload_section').addClass('uploading');
      });
   
      // Update the progress bar.
      $('.cloudinary-fileupload').bind('fileuploadprogress', function(e, data) {
        var percent = Math.round((data.loaded * 100.0) / data.total);
        $('.progress_bar .completed').css('width', percent + '%');
        if (percent == 100) {
          $('.upload_section').removeClass('uploading').addClass('processing');
        }    
      });
   
      // Handle failed uploading (e.g., not a valid image)
      $('.cloudinary-fileupload').bind('fileuploadfail', function(e, data) {
          $('.upload_section').removeClass('uploading processing');        
      });        
         
      // When uploading is completed, show the 4 thumbnails and photo sharing form.    
      $('.cloudinary-fileupload').bind('cloudinarydone', function(e, data) {
        jQuery("abbr.timeago").timeago();
        $.each(transformations, function(kind, transformation) {
          $('.kind_selection .' + kind + ' .image').html(              
            $.cloudinary.image(data.result.public_id,
              $.extend({ format: data.result.format, version: data.result.version }, transformation))              
          );
        });            
        $('.upload_section').removeClass('uploading processing').addClass('uploaded');
      });
   
      // Define a drag & drop area and update its look & feel while dragging.
      $('.cloudinary-fileupload').fileupload('option', 'dropZone',  $('.drag_area'));
      $(document).bind('dragover', function (e) {
          var dropZone = $('.drag_area'),
          timeout = window.dropZoneTimeout;
          if (!timeout) {
              dropZone.addClass('in');
          } else {
              clearTimeout(timeout);
          }
          window.dropZoneTimeout = setTimeout(function () {
              window.dropZoneTimeout = null;
              dropZone.removeClass('in');
          }, 100);
      });    
                 
      // Show technical details panel when clicking on a link.
      $('.details_link').click(function() {
        $('.technical_details').show();
        return false;
      });
   
      // Hide technical details panel on click.
      $('.technical_details .close').click(function() {
        $('.technical_details').hide();
        return false;
      });
     
    });
  </script>
</head>
<body>
  <div id="photo_share">
    <div id="header">
      <div class="inner">
        <a href="http://cloudinary.com/" target="_blank">
          <img alt="Cloudinary_logo" class="cloudinary_logo" height="30" src="http://res.cloudinary.com/cloudinary-pubnub-demo/image/upload/c_scale,h_30,w_142/cloudinary_logo.png" width="142">        </a>
        <h1>Photo Share - Demo</h1>
        <a href="http://www.pubnub.com/" target="_blank">
          <img alt="Pubnub_logo" class="pubnub_logo" height="24" src="http://res.cloudinary.com/cloudinary-pubnub-demo/image/upload/c_scale,h_24,w_107/pubnub_logo.png" width="107">        </a>
      </div>
    </div>
    <div id="content">
      <div class="upload_section">
        <form action="/share" class="share_form" method="POST">
          <div class="drag_area">
            <div class="drag_inner">
              <span>
                Drop Photo Here
                <span class="small">or</span>
              </span>
              <div class="upload_button_holder">
                <input class="select_files" type="submit" value="Select Photo">
                <input class="cloudinary-fileupload" data-cloudinary-field="photo_id" data-form-data="{&quot;timestamp&quot;:1643786910,&quot;transformation&quot;:&quot;c_limit,h_1200,w_1200/fl_relative,g_north,l_logos_watermark,o_40,w_0.7,y_20&quot;,&quot;callback&quot;:&quot;http://cloudinary-pubnub-demo.herokuapp.com/cloudinary_cors.html&quot;,&quot;eager&quot;:&quot;c_fill,g_face,h_100,r_20,w_150|c_fill,e_sepia,g_face,h_100,r_20,w_150|c_fill,e_improve,g_face,h_100,r_20,w_150|c_fill,e_hue:70,g_face,h_100,r_20,w_150/e_blue:50|c_limit,h_600,w_600&quot;,&quot;signature&quot;:&quot;da822ddf52278ce97c3f1664e031ebba640b061d&quot;,&quot;api_key&quot;:&quot;118815251311357&quot;}" data-url="https://api.cloudinary.com/v1_1/cloudinary-pubnub-demo/image/upload" name="file" type="file">              </div>
            </div>
          </div>
          <a class="details_link" href="#">How does it work?</a>
          <div class="upload_progress">
            <span>Uploading...</span>
            <div class="progress_bar">
              <div class="completed"></div>
            </div>
          </div>
          <div class="processing_progress">
            <span>Processing...</span>
            <img alt="Processing..." height="32" src="/ajax-loader.gif" width="32">
          </div>
          <div class="share_details_section">
            <ul class="kind_selection">
              <li class="natural">
                <label for="kind_field_natural">
                  <span class="name">Natural</span>
                  <span class="image"></span>
                </label>
                <input checked="" id="kind_field_natural" name="kind" type="radio" value="natural">
              </li>
              <li class="sepia">
                <label for="kind_field_sepia">
                  <span class="name">Sepia</span>
                  <span class="image"></span>
                </label>
                <input id="kind_field_sepia" name="kind" type="radio" value="sepia">
              </li>
              <li class="improved">
                <label for="kind_field_improved">
                  <span class="name">Improved</span>
                  <span class="image"></span>
                </label>
                <input id="kind_field_improved" name="kind" type="radio" value="improved">
              </li>
              <li class="blue">
                <label for="kind_field_blue">
                  <span class="name">Blue</span>
                  <span class="image"></span>
                </label>
                <input id="kind_field_blue" name="kind" type="radio" value="blue">
              </li>
            </ul>
            <div class="fields">
              <div class="field">
                <label for="user_field">Name:</label>
                <input id="user_field" maxlength="30" name="user" type="text" value="Anonymous">
              </div>
              <div class="field">
                <label for="user_field">Message:</label>
                <input id="message_field" maxlength="80" name="message" type="text" value="Look at this!">
              </div>
            </div>
            <input type="submit" value="Share">
          </div>
        </form>
      </div>
      <div class="stream_section">
        <h2>Live share stream</h2>
        <ul class="stream"></ul>
      </div>
      <div class="technical_details">
        <ol>
          <li>Cloudinary's jQuery plugin is used to perform direct uploading to the cloud from the browser.</li>
          <li>Signature for authorizing uploads to Cloudinary are generated on the server side and included in the HTML page.</li>
          <li>Cloudinary's cloud-based transformations are applied: generating thumbnails using face detection based cropping, adding a watermark, applying effects.</li>
          <li>Cloudinary's image identifier as well as user name and message are sent to the web server that securely publishes a real time message to a PubNub channel.</li>
          <li>The web page uses PubNub's Javascript library to subscribe to a real-time live messaging channel shared by all users.</li>
          <li>Messages received via PubNub are used to trigger the live shared photos stream's display.</li>
          <li>The thumbnails and full-size images are generated and delivered through a fast CDN by Cloudinary. Image URLs are built using Cloudinary's jQuery plugin based on the identifier included in the PubNub message.</li>
          <li>Previously published messages are also displayed on page loading using PubNub's History support.</li>
        </ol>
        <p>
          Full sources are available on
          <a href="https://github.com/cloudinary/cloudinary_pubnub_demo" target="_blank">GitHub</a>
        </p>
        <a class="close" href="#">Close</a>
      </div>
    </div>
  </div>

</body></html>
